function doPost(e) {
  try {
    // Get the active spreadsheet - replace with your actual spreadsheet ID
    var sheet = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID_HERE').getActiveSheet();
    
    // If this is the first time, add comprehensive headers
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 27).setValues([[
        'Timestamp', 'Name', 'Section', 'Roll', 'Admission No',
        // Maths
        'Maths Correct', 'Maths Wrong', 'Maths Blank', 'Maths Total', 'Maths Percentage',
        // Physics
        'Physics Correct', 'Physics Wrong', 'Physics Blank', 'Physics Total', 'Physics Percentage',
        // Chemistry
        'Chemistry Correct', 'Chemistry Wrong', 'Chemistry Blank', 'Chemistry Total', 'Chemistry Percentage',
        // Overall
        'Total Correct', 'Total Wrong', 'Total Blank', 'Total Questions', 'Overall Percentage',
        'Exam Status'
      ]]);
    }
    
    // Get the parameters from the request
    var params = e.parameter;
    
    // Check if student already exists
    var data = sheet.getDataRange().getValues();
    var existingRow = -1;
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === params.name && 
          data[i][2] === params.section && 
          data[i][3] === params.roll && 
          data[i][4] === params.adm) {
        existingRow = i + 1;
        break;
      }
    }
    
    // Prepare student data object
    var studentData = {
      timestamp: params.timestamp || new Date(),
      name: params.name || 'Unknown',
      section: params.section || 'Unknown',
      roll: params.roll || 'Unknown',
      adm: params.adm || 'Unknown',
      subjects: {},
      totals: { correct: 0, wrong: 0, blank: 0, total: 0 }
    };
    
    // If student exists, get their current data
    if (existingRow > 0) {
      var existingData = sheet.getRange(existingRow, 1, 1, 27).getValues()[0];
      studentData.timestamp = existingData[0];
      // Extract existing subject data
      studentData.subjects.Maths = {
        correct: existingData[5] || 0, wrong: existingData[6] || 0, blank: existingData[7] || 0, 
        total: existingData[8] || 0, percentage: parseFloat(existingData[9]) || 0
      };
      studentData.subjects.Physics = {
        correct: existingData[10] || 0, wrong: existingData[11] || 0, blank: existingData[12] || 0, 
        total: existingData[13] || 0, percentage: parseFloat(existingData[14]) || 0
      };
      studentData.subjects.Chemistry = {
        correct: existingData[15] || 0, wrong: existingData[16] || 0, blank: existingData[17] || 0, 
        total: existingData[18] || 0, percentage: parseFloat(existingData[19]) || 0
      };
      studentData.totals = {
        correct: existingData[20] || 0, wrong: existingData[21] || 0, blank: existingData[22] || 0,
        total: existingData[23] || 0, percentage: parseFloat(existingData[24]) || 0
      };
    }
    
    // Update with new subject data
    var subject = params.subject || 'Unknown';
    studentData.subjects[subject] = {
      correct: parseInt(params.correct) || 0,
      wrong: parseInt(params.wrong) || 0,
      blank: parseInt(params.blank) || 0,
      total: parseInt(params.total) || 0,
      percentage: parseFloat(params.percentage) || 0
    };
    
    // Recalculate totals
    studentData.totals = { correct: 0, wrong: 0, blank: 0, total: 0 };
    for (var subj in studentData.subjects) {
      if (studentData.subjects.hasOwnProperty(subj)) {
        var subjData = studentData.subjects[subj];
        studentData.totals.correct += subjData.correct;
        studentData.totals.wrong += subjData.wrong;
        studentData.totals.blank += subjData.blank;
        studentData.totals.total += subjData.total;
      }
    }
    
    // Calculate overall percentage
    studentData.totals.percentage = studentData.totals.total > 0 ? 
      ((studentData.totals.correct / studentData.totals.total) * 100).toFixed(2) : 0;
    
    // Check if all subjects are completed
    var allSubjectsCompleted = studentData.subjects.Maths && 
                              studentData.subjects.Physics && 
                              studentData.subjects.Chemistry;
    
    // Prepare the row data
    var row = [
      studentData.timestamp,
      studentData.name,
      studentData.section,
      studentData.roll,
      studentData.adm,
      // Maths data
      studentData.subjects.Maths ? studentData.subjects.Maths.correct : '',
      studentData.subjects.Maths ? studentData.subjects.Maths.wrong : '',
      studentData.subjects.Maths ? studentData.subjects.Maths.blank : '',
      studentData.subjects.Maths ? studentData.subjects.Maths.total : '',
      studentData.subjects.Maths ? studentData.subjects.Maths.percentage + '%' : '',
      // Physics data
      studentData.subjects.Physics ? studentData.subjects.Physics.correct : '',
      studentData.subjects.Physics ? studentData.subjects.Physics.wrong : '',
      studentData.subjects.Physics ? studentData.subjects.Physics.blank : '',
      studentData.subjects.Physics ? studentData.subjects.Physics.total : '',
      studentData.subjects.Physics ? studentData.subjects.Physics.percentage + '%' : '',
      // Chemistry data
      studentData.subjects.Chemistry ? studentData.subjects.Chemistry.correct : '',
      studentData.subjects.Chemistry ? studentData.subjects.Chemistry.wrong : '',
      studentData.subjects.Chemistry ? studentData.subjects.Chemistry.blank : '',
      studentData.subjects.Chemistry ? studentData.subjects.Chemistry.total : '',
      studentData.subjects.Chemistry ? studentData.subjects.Chemistry.percentage + '%' : '',
      // Overall totals
      studentData.totals.correct,
      studentData.totals.wrong,
      studentData.totals.blank,
      studentData.totals.total,
      studentData.totals.percentage + '%',
      // Exam status
      allSubjectsCompleted ? 'Completed' : 'In Progress'
    ];
    
    // Update or append the row
    if (existingRow > 0) {
      sheet.getRange(existingRow, 1, 1, 27).setValues([row]);
    } else {
      sheet.appendRow(row);
    }
    
    // Return success response
    return ContentService
      .createTextOutput(JSON.stringify({
        result: 'success', 
        action: existingRow > 0 ? 'updated' : 'created',
        allCompleted: allSubjectsCompleted
      }))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // Return error response
    return ContentService
      .createTextOutput(JSON.stringify({result: 'error', error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({status: 'online', message: 'LFJC Exam System API - One Row Per Student'}))
    .setMimeType(ContentService.MimeType.JSON);
}
